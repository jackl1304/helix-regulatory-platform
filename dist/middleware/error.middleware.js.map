{"version":3,"file":"error.middleware.js","sourceRoot":"","sources":["../../server/middleware/error.middleware.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,QAAQ,EAAE,MAAM,KAAK,CAAC;AAC/B,OAAO,EAAE,MAAM,EAAE,MAAM,4BAA4B,CAAC;AAEpD,MAAM,QAAS,SAAQ,KAAK;IAI1B,YAAY,OAAe,EAAE,aAAqB,GAAG,EAAE,gBAAyB,IAAI;QAClF,KAAK,CAAC,OAAO,CAAC,CAAC;QACf,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,aAAa,GAAG,aAAa,CAAC;QACnC,KAAK,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;IAClD,CAAC;CACF;AAED,MAAM,eAAgB,SAAQ,QAAQ;IAKpC,YAAY,OAAe,EAAE,KAAa,EAAE,KAAc,EAAE,YAAoB;QAC9E,KAAK,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QACpB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;IACnC,CAAC;CACF;AAED,MAAM,aAAc,SAAQ,QAAQ;IAKlC,YAAY,OAAe,EAAE,SAAiB,EAAE,KAAc,EAAE,aAAqB;QACnF,KAAK,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QACpB,IAAI,CAAC,SAAS,GAAG,SAAS,CAAC;QAC3B,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,aAAa,GAAG,aAAa,IAAI,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC;IAC3D,CAAC;CACF;AAED,MAAM,UAAU,GAAG,CAAC,KAAU,EAAqB,EAAE;IACnD,OAAO,KAAK,YAAY,QAAQ,CAAC;AACnC,CAAC,CAAC;AAEF,MAAM,kBAAkB,GAAG,CAAC,KAAe,EAAW,EAAE;IACtD,OAAO,KAAK,CAAC,aAAa,CAAC;AAC7B,CAAC,CAAC;AAEF,MAAM,mBAAmB,GAAG,CAAC,KAAe,EAAE,EAAE;IAC9C,OAAO;QACL,KAAK,EAAE;YACL,OAAO,EAAE,KAAK,CAAC,OAAO;YACtB,UAAU,EAAE,KAAK,CAAC,UAAU;YAC5B,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,CAAC;SACrE;KACF,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,MAAM,GAAG,IAAI,MAAM,CAAC,iBAAiB,CAAC,CAAC;AAG7C,MAAM,CAAC,MAAM,YAAY,GAAG,CAAC,EAAY,EAAE,EAAE;IAC3C,OAAO,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAE,EAAE;QACzD,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;IAClD,CAAC,CAAC;AACJ,CAAC,CAAC;AAGF,MAAM,CAAC,MAAM,YAAY,GAAG,CAC1B,KAAY,EACZ,GAAY,EACZ,GAAa,EACb,IAAkB,EACZ,EAAE;IACR,IAAI,cAAwB,CAAC;IAG7B,IAAI,KAAK,YAAY,QAAQ,EAAE,CAAC;QAC9B,MAAM,gBAAgB,GAAG,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAChD,KAAK,EAAE,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC;YACzB,OAAO,EAAE,GAAG,CAAC,OAAO;YACpB,IAAI,EAAE,GAAG,CAAC,IAAI;SACf,CAAC,CAAC,CAAC;QAEJ,cAAc,GAAG,IAAI,eAAe,CAClC,2BAA2B,EAC3B,gBAAgB,CAAC,CAAC,CAAC,EAAE,KAAK,IAAI,SAAS,EACvC,SAAS,EACT,aAAa,CACd,CAAC;IACJ,CAAC;SAEI,IAAI,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC;QAC3B,cAAc,GAAG,KAAK,CAAC;IACzB,CAAC;SAEI,CAAC;QACJ,cAAc,GAAG,IAAI,QAAQ,CAC3B,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY;YACnC,CAAC,CAAC,uBAAuB;YACzB,CAAC,CAAC,KAAK,CAAC,OAAO,IAAI,wBAAwB,EAC7C,GAAG,EACH,KAAK,CACN,CAAC;IACJ,CAAC;IAGD,IAAI,kBAAkB,CAAC,cAAc,CAAC,EAAE,CAAC;QACvC,MAAM,CAAC,IAAI,CAAC,4BAA4B,EAAE;YACxC,KAAK,EAAE,cAAc,CAAC,OAAO;YAC7B,UAAU,EAAE,cAAc,CAAC,UAAU;YACrC,GAAG,EAAE,GAAG,CAAC,WAAW;YACpB,MAAM,EAAE,GAAG,CAAC,MAAM;YAClB,SAAS,EAAE,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC;YAChC,EAAE,EAAE,GAAG,CAAC,EAAE;SACX,CAAC,CAAC;IACL,CAAC;SAAM,CAAC;QACN,MAAM,CAAC,KAAK,CAAC,gCAAgC,EAAE;YAC7C,KAAK,EAAE,cAAc,CAAC,OAAO;YAC7B,KAAK,EAAE,cAAc,CAAC,KAAK;YAC3B,UAAU,EAAE,cAAc,CAAC,UAAU;YACrC,GAAG,EAAE,GAAG,CAAC,WAAW;YACpB,MAAM,EAAE,GAAG,CAAC,MAAM;YAClB,SAAS,EAAE,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC;YAChC,EAAE,EAAE,GAAG,CAAC,EAAE;SACX,CAAC,CAAC;IACL,CAAC;IAGD,MAAM,aAAa,GAAG,mBAAmB,CAAC,cAAc,CAAC,CAAC;IAC1D,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;AAC5D,CAAC,CAAC;AAGF,MAAM,CAAC,MAAM,eAAe,GAAG,CAAC,GAAY,EAAE,GAAa,EAAE,IAAkB,EAAQ,EAAE;IACvF,MAAM,KAAK,GAAG,IAAI,QAAQ,CAAC,SAAS,GAAG,CAAC,WAAW,YAAY,EAAE,GAAG,CAAC,CAAC;IACtE,IAAI,CAAC,KAAK,CAAC,CAAC;AACd,CAAC,CAAC;AAGF,MAAM,CAAC,MAAM,mBAAmB,GAAG,CAAC,KAAc,EAAE,SAAiB,EAAE,KAAc,EAAS,EAAE;IAC9F,MAAM,CAAC,KAAK,CAAC,yBAAyB,EAAE;QACtC,SAAS;QACT,KAAK;QACL,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;KAC9D,CAAC,CAAC;IAEH,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;QAC3B,MAAM,IAAI,aAAa,CAAC,KAAK,CAAC,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC;IAClE,CAAC;IAED,MAAM,IAAI,aAAa,CAAC,wBAAwB,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;AACtE,CAAC,CAAC;AAGF,MAAM,CAAC,MAAM,qBAAqB,GAAG,CACnC,KAAa,EACb,KAAc,EACd,YAAoB,EACpB,aAAsB,EACf,EAAE;IACT,MAAM,OAAO,GAAG,aAAa,IAAI,qBAAqB,KAAK,EAAE,CAAC;IAC9D,MAAM,IAAI,eAAe,CAAC,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,YAAY,CAAC,CAAC;AACjE,CAAC,CAAC;AAGF,MAAM,CAAC,MAAM,0BAA0B,GAAG,CACxC,WAAmB,EACnB,KAAc,EACd,OAAiC,EAC1B,EAAE;IACT,MAAM,CAAC,KAAK,CAAC,wBAAwB,EAAE;QACrC,WAAW;QACX,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;QAC7D,GAAG,OAAO;KACX,CAAC,CAAC;IAEH,MAAM,OAAO,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,8BAA8B,CAAC;IACxF,MAAM,IAAI,QAAQ,CAAC,GAAG,WAAW,mBAAmB,OAAO,EAAE,EAAE,GAAG,CAAC,CAAC;AACtE,CAAC,CAAC;AAGF,OAAO,CAAC,EAAE,CAAC,oBAAoB,EAAE,CAAC,MAAe,EAAE,OAAqB,EAAE,EAAE;IAC1E,MAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE;QAC1C,MAAM,EAAE,MAAM,YAAY,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC;QACjE,KAAK,EAAE,MAAM,YAAY,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS;KAC1D,CAAC,CAAC;IAGH,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY,EAAE,CAAC;QAC1C,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAClB,CAAC;AACH,CAAC,CAAC,CAAC;AAGH,OAAO,CAAC,EAAE,CAAC,mBAAmB,EAAE,CAAC,KAAY,EAAE,EAAE;IAC/C,MAAM,CAAC,KAAK,CAAC,oBAAoB,EAAE;QACjC,KAAK,EAAE,KAAK,CAAC,OAAO;QACpB,KAAK,EAAE,KAAK,CAAC,KAAK;KACnB,CAAC,CAAC;IAGH,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC,CAAC;AAGH,MAAM,gBAAgB,GAAG,CAAC,MAAc,EAAE,EAAE;IAC1C,MAAM,CAAC,IAAI,CAAC,YAAY,MAAM,4BAA4B,CAAC,CAAC;IAE5D,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;AAEF,OAAO,CAAC,EAAE,CAAC,SAAS,EAAE,GAAG,EAAE,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC,CAAC;AACzD,OAAO,CAAC,EAAE,CAAC,QAAQ,EAAE,GAAG,EAAE,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,CAAC","sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { Logger } from '../services/logger.service';\n// Define error types locally since @shared/types doesn't exist\nclass AppError extends Error {\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n\n  constructor(message: string, statusCode: number = 500, isOperational: boolean = true) {\n    super(message);\n    this.statusCode = statusCode;\n    this.isOperational = isOperational;\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\nclass ValidationError extends AppError {\n  public readonly field: string;\n  public readonly value: unknown;\n  public readonly expectedType: string;\n\n  constructor(message: string, field: string, value: unknown, expectedType: string) {\n    super(message, 400);\n    this.field = field;\n    this.value = value;\n    this.expectedType = expectedType;\n  }\n}\n\nclass DatabaseError extends AppError {\n  public readonly operation: string;\n  public readonly table?: string;\n  public readonly originalError: Error;\n\n  constructor(message: string, operation: string, table?: string, originalError?: Error) {\n    super(message, 500);\n    this.operation = operation;\n    this.table = table;\n    this.originalError = originalError || new Error(message);\n  }\n}\n\nconst isAppError = (error: any): error is AppError => {\n  return error instanceof AppError;\n};\n\nconst isOperationalError = (error: AppError): boolean => {\n  return error.isOperational;\n};\n\nconst formatErrorResponse = (error: AppError) => {\n  return {\n    error: {\n      message: error.message,\n      statusCode: error.statusCode,\n      ...(process.env.NODE_ENV !== 'production' && { stack: error.stack })\n    }\n  };\n};\n\nconst logger = new Logger('ErrorMiddleware');\n\n// Async handler wrapper to catch async errors\nexport const asyncHandler = (fn: Function) => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n};\n\n// Global error handler middleware\nexport const errorHandler = (\n  error: Error,\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void => {\n  let processedError: AppError;\n\n  // Handle Zod validation errors\n  if (error instanceof ZodError) {\n    const validationErrors = error.errors.map(err => ({\n      field: err.path.join('.'),\n      message: err.message,\n      code: err.code\n    }));\n    \n    processedError = new ValidationError(\n      'Request validation failed',\n      validationErrors[0]?.field || 'unknown',\n      'invalid',\n      'valid input'\n    );\n  }\n  // Handle known application errors\n  else if (isAppError(error)) {\n    processedError = error;\n  }\n  // Handle unknown errors\n  else {\n    processedError = new AppError(\n      process.env.NODE_ENV === 'production' \n        ? 'Internal server error'\n        : error.message || 'Unknown error occurred',\n      500,\n      false\n    );\n  }\n\n  // Log the error\n  if (isOperationalError(processedError)) {\n    logger.warn('Operational error occurred', {\n      error: processedError.message,\n      statusCode: processedError.statusCode,\n      url: req.originalUrl,\n      method: req.method,\n      userAgent: req.get('User-Agent'),\n      ip: req.ip\n    });\n  } else {\n    logger.error('Non-operational error occurred', {\n      error: processedError.message,\n      stack: processedError.stack,\n      statusCode: processedError.statusCode,\n      url: req.originalUrl,\n      method: req.method,\n      userAgent: req.get('User-Agent'),\n      ip: req.ip\n    });\n  }\n\n  // Send error response\n  const errorResponse = formatErrorResponse(processedError);\n  res.status(processedError.statusCode).json(errorResponse);\n};\n\n// 404 Not Found handler\nexport const notFoundHandler = (req: Request, res: Response, next: NextFunction): void => {\n  const error = new AppError(`Route ${req.originalUrl} not found`, 404);\n  next(error);\n};\n\n// Database error handler\nexport const handleDatabaseError = (error: unknown, operation: string, table?: string): never => {\n  logger.error('Database error occurred', {\n    operation,\n    table,\n    error: error instanceof Error ? error.message : String(error)\n  });\n\n  if (error instanceof Error) {\n    throw new DatabaseError(error.message, operation, table, error);\n  }\n  \n  throw new DatabaseError('Unknown database error', operation, table);\n};\n\n// Validation error handler\nexport const handleValidationError = (\n  field: string,\n  value: unknown,\n  expectedType: string,\n  customMessage?: string\n): never => {\n  const message = customMessage || `Invalid value for ${field}`;\n  throw new ValidationError(message, field, value, expectedType);\n};\n\n// External service error handler\nexport const handleExternalServiceError = (\n  serviceName: string,\n  error: unknown,\n  context?: Record<string, unknown>\n): never => {\n  logger.error('External service error', {\n    serviceName,\n    error: error instanceof Error ? error.message : String(error),\n    ...context\n  });\n\n  const message = error instanceof Error ? error.message : 'External service unavailable';\n  throw new AppError(`${serviceName} service error: ${message}`, 502);\n};\n\n// Process unhandled promise rejections\nprocess.on('unhandledRejection', (reason: unknown, promise: Promise<any>) => {\n  logger.error('Unhandled Promise Rejection', {\n    reason: reason instanceof Error ? reason.message : String(reason),\n    stack: reason instanceof Error ? reason.stack : undefined\n  });\n  \n  // In production, gracefully shutdown\n  if (process.env.NODE_ENV === 'production') {\n    process.exit(1);\n  }\n});\n\n// Process uncaught exceptions\nprocess.on('uncaughtException', (error: Error) => {\n  logger.error('Uncaught Exception', {\n    error: error.message,\n    stack: error.stack\n  });\n  \n  // Always exit on uncaught exception\n  process.exit(1);\n});\n\n// Graceful shutdown handlers\nconst gracefulShutdown = (signal: string) => {\n  logger.info(`Received ${signal}, shutting down gracefully`);\n  \n  process.exit(0);\n};\n\nprocess.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\nprocess.on('SIGINT', () => gracefulShutdown('SIGINT'));"]}